<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ECHONET Air Conditioner controller</title>
	<link rel="stylesheet" href="/js/jquery.mobile-1.4.5/css/themes/default/jquery.mobile-1.4.5.min.css">
	<link rel="shortcut icon" href="/favicon.ico">
	<script src="/js/jquery.mobile-1.4.5/jquery.min.js"></script>
	<script src="/js/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="/js/spin.min.js"></script>
	<script src='/js/websock.js'></script>
</head>

<body>
<div data-role="page" id='mainpage'>
	<div data-role="header" style="text-align:center;">ECHONET Lite Air-Conditioner Standard Remote Controller</div>
	<div role="main" class="ui-content" id='mainpage-body'>
	<ul data-role="listview" data-inset="true" id='devlist'>
	No air-conditioner is available.
	</ul>
	</div>
	<div data-role="footer" style="text-align:center;">&copy; 2017 Kanagawa Institute of Technology</div>
</div>

<div data-role="page" id='controlpage'>
	<div data-role="header" style="text-align:center;">
	<a href="#mainpage" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-back">Back</a>
	<h1>ECHONET Lite Air-Conditioner Standard Remote Controller</h1></div>
	<div role="main" class="ui-content">

		<form id='frm'>
		<!-- Power -->
		<fieldset data-role="controlgroup" data-type="horizontal" style='width:100%'>
			<input type="radio" name="OperatingState" id="OperatingState-on" value="on">
		    <label for="OperatingState-on">On</label>
		    <input type="radio" name="OperatingState" id="OperatingState-off" value="off">
		    <label for="OperatingState-off">Off</label>
		</fieldset>
		<!-- Mode -->
		<fieldset data-role="controlgroup" data-type="horizontal">
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-auto" value="auto">
		    <label for="OperationModeSetting-auto">Auto</label>
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-cool" value="cool">
		    <label for="OperationModeSetting-cool">Cool</label>
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-heat" value="heat">
		    <label for="OperationModeSetting-heat">Heat</label>
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-dry" value="dry">
		    <label for="OperationModeSetting-dry">Dry</label>
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-wind" value="wind">
		    <label for="OperationModeSetting-wind">Wind</label>
		    <input type="radio" name="OperationModeSetting" id="OperationModeSetting-others" value="others">
		    <label for="OperationModeSetting-others">Others</label>
		</fieldset>
		<label for="TemperatureSetValue">Temperature</label>
		<input type="range" name="TemperatureSetValue" id="TemperatureSetValue" min="0" max="50" value="25" >
		</form>

		<p><a href="#mainpage" data-direction="reverse" class="ui-btn ui-shadow ui-corner-all ui-btn-b">Back to air-conditioner list</a></p>
	</div>
	<div data-role="footer" style="text-align:center;">&copy; 2017 Kanagawa Institute of Technology</div>
</div>
</body>
<script>
let urlVars = {} ;
if( location.search.length>0 ){
	let eqs = location.search.substring(1).split('&') ;
	eqs.forEach(function(eq){
		let terms = eq.split('=') ;
		urlVars[terms[0]]=(terms.length<2?null:terms[1]) ;
	}) ;
}


let picogw ;
let bInitialized = false ;
let devices ;

onload = function(){
	if( urlVars.ip == null ){
		$('#mainpage-body').html('<div align="center"><h2>PicoGW IP address should be specified.</h2></div>') ;
		$('#mainpage').page() ;
		return ;
	}
	connectws(_picogw=>{
		picogw = _picogw ;

		if( bInitialized ) return ;
		bInitialized = true ;

		// Search echonet lite aircons
		const pathprefix = '/v1/echonet' ;
		start_spinner();
		picogw.callproc({
			method:'GET'
			,path: pathprefix
		}).then(devhash=>{
			stop_spinner();
			let devlist = [] ;
			for( let dev in devhash ){
				if( dev.indexOf('AirConditioner_') == 0 )
					devlist.push(dev) ;
			}
			if( devlist.length == 0 )	return ;

			devices = {} ;
			start_spinner();
			Promise.all(devlist.map(dev=>new Promise((ac,rj)=>{
				picogw.callproc({
					method:'GET'
					,path: pathprefix+'/'+dev
				}).then(cache=>{
					devices[pathprefix+'/'+dev] = cache ;
					ac() ;
				}).catch(e=>{
					ac() ;
				});
			}))).then(()=>{
				stop_spinner();
				let ht = '' ;
				for( let path in devices ){
					let desc = '' ;
					['OperatingState','InstallationLocation','ManufacturerCode'].forEach(elem=>{
						try {
							desc += ` ${elem} = ${devices[path][elem].cache_value} :`
						} catch(e){}
					}) ;

					ht += `<li><a href="#controlpage" onclick="on_dev_selected('${path}')">`
						+`<img src="ECHONET_AirConditioner.png"></img><h2>${path.split('/').slice(-1)[0]}</h2>`
						+`<p>${desc.slice(0,-1)}</p>`	 // Remove last ','
						+`</a></li>` ;
				} ;

				$('#devlist').html(ht).listview('refresh');
			}).catch(e=>{stop_spinner();}) ;
		}).catch(e=>{
			stop_spinner();
			$('#mainpage-body').html('Error in accessing /v1/echonet/AirConditioner_.+') ;
			$('#mainpage').page();
		}) ;
	},urlVars.ip) ;
} ;

function simple_enum_setup(dev_path,propname,cache){
	if( cache == null ){
		// Property does not exist
		return ;
	}

	let prev_cval = cache.cache_value ;
	if( prev_cval == null )
		return ;	// Cache value is not obtained yet
	$(`#${propname}-${prev_cval}`).attr('checked','checked') ;
	$(`label[for='${propname}-${prev_cval}']`).addClass('ui-btn-active') ;
	//$(`#${propname}-${prev_cval}`).removeAttr('checked') ;

	picogw.sub(dev_path+'/'+propname,re=>{
		let cval = re[dev_path+'/'+propname].value ;
		$(`label[for='${propname}-${prev_cval}']`).removeClass('ui-btn-active') ;
		$(`label[for='${propname}-${cval}']`).addClass('ui-btn-active') ;
		prev_cval = cval ;
		//$('#controlpage').page();
	});

	// Set handler
	return newval=>{
		start_spinner();
		picogw.callproc({
			method:'PUT'
			,path:dev_path+'/'+propname
			,args:{value:newval}
		}).then(re=>{stop_spinner();console.log(re);}).catch(e=>{stop_spinner();});
		prev_cval = newval ;
		//console.log(`${propname} : ${newval}`) ;
	} ;
}

//<input type="range" name="TemperatureSetValue" id="TemperatureSetValue" min="0" max="50" value="25">

function slider_setup(dev_path,sliderSettings,cache){
	const propName = sliderSettings[0] ;
	const propMin = sliderSettings[1] , propMax = sliderSettings[2] ;
	if( cache == null ) cache = propMin ;
	$(`#${propName}`).attr('min',propMin) ;
	$(`#${propName}`).attr('max',propMax) ;
	$(`#${propName}`).attr('value',cache) ;

	picogw.sub(dev_path+'/'+propName,re=>{
		$(`#${propName}`).val(re[dev_path+'/'+propName].value).slider('refresh');
	});

	// Set handler
	return newval=>{
		start_spinner();
		picogw.callproc({
			method:'PUT'
			,path:dev_path+'/'+propName
			,args:{value:newval}
		}).then(re=>{stop_spinner();console.log(re);}).catch(e=>{stop_spinner();});
		prev_cval = newval ;
		console.log(`${propName} : ${newval}`) ;
	} ;
}

const set_handlers = {} ;
const SimpleEnumProperties = ['OperatingState','OperationModeSetting'] ;
const SliderProperties = [['TemperatureSetValue',0,50]] ;

on_dev_selected = dev_path =>{
	localStorage.setItem('dev_path',dev_path) ;
}

$("#controlpage").on("pagehide",function(event) {
	picogw.unsub() ;
}) ;
$("#controlpage").on("pagebeforeshow",function(event) {
	let dev_path = localStorage.getItem('dev_path') ;
	function setupControls(){
		let devCache = devices[dev_path] ;

		// Simple enum properties
		SimpleEnumProperties.forEach(pname=>{
			set_handlers[pname] = simple_enum_setup(dev_path,pname,devCache[pname]) ;
		}) ;

		// Slider properties
		SliderProperties.forEach(sliderSettings=>{
			set_handlers[sliderSettings[0]] = slider_setup(dev_path,sliderSettings,devCache[sliderSettings[0]].cache_value) ;
		}) ;
	}

	if( devices != null ) setupControls() ;
	else {
		let iid = setInterval(()=>{
			if( devices == null ) return ;
			clearInterval(iid) ;
			setupControls() ;
		},1000) ;
	}
});

$(document).on('change', '[type="radio"]', function(){ 
	try {
		set_handlers[this.name](this.value) ;
	} catch(e){}
});

SliderProperties.forEach(sliderSettings=>{
	$('#frm').on('slidestop','#'+sliderSettings[0], function(){ 
		try {
			set_handlers[this.name](parseInt(this.value)) ;
		} catch(e){}
	});
});

</script>
</html>
