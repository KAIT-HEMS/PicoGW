<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="js/jstree-themes/default/style.min.css" />
</head>
<body>
<img src='res/PicoGW.png' style='height:50px;'></img><span style='float:right'>
A minimalist's home gateway that hosts <a href='http://www.daiwahouse.co.jp/lab/HousingAPI/' target='_blank'>Housing API</a></span>
<br clear='all'>
<div id="tabs">
  <ul>
    <li><a href="#tabs-resources">API Hierarchy</a></li>
    <li><a href="#tabs-howto">Howto</a></li>
    <li><a href="#tabs-about">About</a></li>
  </ul>

<div id='tabs-resources'>
<div id="resource_tree"></div>
</div>

<div id='tabs-howto'>
To access ECHONET Lite device, right click the device's property name (such as OperatingState) and select 'Open API', which generates ECHONET Lite's GET access to the property in new tab. The detailed description is on <a href="https://github.com/KAIT-HEMS/PicoGW/blob/master/README.md" target="_blank">GitHub README.</a>.
</div>

<div id='tabs-about'>
This software is originally developed by Shigeru Owada@Kanagawa Instutite of Technology.<br />
This is distributed from <a href='https://github.com/KAIT-HEMS/PicoGW' target="_blank">GitHub</a> by MIT license.
<h2>Licenses</h2>
<h4>MIT</h4>
<li><a href='https://jquery.com/' target='_blank'>jQuery</a></li>
<li><a href='https://jqueryui.com/' target='_blank'>jQuery UI</a></li>
<li><a href='https://www.jstree.com/' target='_blank'>jsTree</a></li>
<li><a href='https://www.npmjs.com/package/arped' target='_blank'>arped</a></li>
<li><a href='https://www.npmjs.com/package/body-parser' target='_blank'>body-parser</a></li>
<li><a href='https://www.npmjs.com/package/echonet-lite' target='_blank'>echonet-lite</a></li>
<li><a href='https://www.npmjs.com/package/express' target='_blank'>express</a></li>
<li><a href='https://www.npmjs.com/package/ipmask' target='_blank'>ipmask</a></li>
<li><a href='https://www.npmjs.com/package/mime' target='_blank'>mime</a></li>
<li><a href='https://www.npmjs.com/package/opts' target='_blank'>opts</a></li>
<li><a href='https://www.npmjs.com/package/ping' target='_blank'>ping</a></li>
<h4>Apache 2.0</h4>
<li><a href='https://www.npmjs.com/package/websocket' target='_blank'>websocket</a></li>
</div>
</body>

<!-- Settings dialog -->
<div id="settings_dialog" title="Settings"> <div id='settings_dlg_json_editor_holder'></div> </div>

<link rel="stylesheet" href='js/jquery-ui-1.12.1/jquery-ui.min.css'></script>
<style>body { font-family: Arial, Helvetica, sans-serif; } table { font-size: 1em; } .ui-draggable, .ui-droppable { background-position: top; }</style>
<script src='js/jquery-3.1.1.min.js'></script>
<script src='js/jquery-ui-1.12.1/jquery-ui.min.js'></script>
<script src='js/jstree.min.js'></script>
<script src='js/jsoneditor.min.js'></script>
<script>
const API_PREFIX = '/v1' ;
var log = console.log ;
var res_tree = $('#resource_tree') ;
var node_properties = {'.':{isleaf:false, settings_schema:undefined, settings:undefined /*,longdoc:undefined*/}} ;

/// Tree activities
function t_open(path){
	return new Promise( (ac,rj)=>{
		var path_real = path.replace(new RegExp('\\.','g'),'/') ;
		$.ajax({
			type: 'GET'
			,url: API_PREFIX+path_real+'?option=true'
			,dataType: 'json'
			,success: function(json){
				var id_to_longdoc = {} ;
				for( var dk in json ){
					var next_path_id = path+dk+'.' ;
					var txt = dk;//`${path_real}${dk}` ;

					node_properties[next_path_id] = {isleaf:true, settings_schema:undefined, settings:undefined /*,longdoc:undefined*/} ;

					var longdoc ;
					try {
						var opt = json[dk].option ;
						node_properties[next_path_id].isleaf = (opt.leaf !== false) ;
						if( opt.doc.short != undefined ) txt += ' (' + opt.doc.short +')' ;
						longdoc = opt.doc.long ;
						/*if( longdoc != undefined)
							node_properties[next_path_id].longdoc = longdoc ;*/
						if( node_properties[next_path_id].settings_schema = opt.settings_schema )
							txt += '<span class="ui-icon ui-icon-gear" style="display:inline-block"></span>';
						node_properties[next_path_id].settings = opt.settings ;

					} catch(e){}

					res_tree.jstree(
						'create_node', '#'+path
						,{ id : next_path_id , text : txt
						, type : (node_properties[next_path_id].isleaf?'file':'folder')});

					if( longdoc )
						id_to_longdoc[next_path_id]=longdoc ;
				}
				res_tree.jstree('open_node', '#'+path);

				for( var path_id in id_to_longdoc)
					document.getElementById(path_id).setAttribute('title',id_to_longdoc[path_id]) ;
				$( document ).tooltip();
			}
			,error: ()=>{
				alert('API call failed:'+path) ;
			}
		});
	}) ;
}

onload = function(){
	$( "#tabs" ).tabs();	// Stylize by jquery ui
	// When selected
	res_tree.on('changed.jstree', function (e, data) {
		if( data.action == 'select_node' ) {
			if( res_tree.jstree( 'is_open' , data.node ) ){
				// Already open
				if( data.node.id != '.')
					res_tree.jstree( 'close_node', data.node);
			} else {// Not open yet
				var selnodename = data.selected[0] ;
				if( node_properties[selnodename].isleaf ){
					if( node_properties[selnodename].longdoc != undefined )
						alert(node_properties[selnodename].longdoc) ;
					else
						alert('No documentation available on this leaf.') ;
				} else {
					t_open(selnodename) ;
				}
			}
		}
	});
	// When closed
	res_tree.on('after_close.jstree',(e,data)=>{
		data.node.children.forEach(cn=>{ delete node_properties[cn] ; })
		res_tree.jstree( 'delete_node', data.node.children) ;
	}) ;
	// Open root elements for first time
	res_tree.on('loaded.jstree',(e,data)=>{ t_open('.'); }) ;
	// Initialize
	res_tree.jstree({
		core: {
			'data': [{id:'.',text:'/'}]
			,'check_callback': true
        }
        ,plugins : [ 'contextmenu' , 'types']
        ,contextmenu : {
        	items:node=>{
        		var menu = {} ;
        		if( node_properties[node.id].settings_schema != undefined ){
        			menu.Settings = {label:'Settings',action:obj=>{
	        			// Reload schema and current value
	        			$.ajax({
	        				url:API_PREFIX+node.id.split('.').slice(0,-2).join('/')+'/?option=true'
	        				,type:'GET',dataType:'json',success:json=>{
	        					var new_node_prop = json[node.id.split('.').slice(-2,-1)[0]] ;
	        					node_properties[node.id].settings_schema = new_node_prop.option.settings_schema ;
	        					node_properties[node.id].settings = new_node_prop.option.settings ;


	        				var settings_schema = node_properties[node.id].settings_schema ;
	        				var settings = node_properties[node.id].settings ;
	        				var editor = new JSONEditor(
	        					document.getElementById('settings_dlg_json_editor_holder')
	        					,{
	        						schema:settings_schema
	        						,theme: 'jqueryui'
	        						,iconlib: 'jqueryui'
	        						,disable_collapse: true
	        						,disable_edit_json: true
	        						,disable_properties: true
	        					}
	        				) ;
	        				if( settings != undefined)
	        					editor.setValue(settings) ;

	        				function cleanup(){editor.destroy();$('#settings_dlg_json_editor_holder').text('') ;}
							$('#settings_dialog').dialog({
								modal: true
								, width: '90%'
								, close : cleanup
								, buttons: {
									Apply: function(){
										var path = node.id.split('.').join('/') ;
										$.ajax({
											type: 'POST'
											,url: API_PREFIX+path+'settings' /*?value='
												+encodeURIComponent(JSON.stringify(editor.getValue()))*/
											,dataType: 'json'
											,data: editor.getValue()
											,success: json=>{
												if( json.error == undefined ) alert('New settings saved.'); else alert(json.error);
											}
											,error: json=>{ alert('API call failed:'+path) ; }
										});

										cleanup() ;
										$( this ).dialog( "close" );
									}
									,Cancel: function(){ cleanup() ; $( this ).dialog( "close" ); }
								}
							}) ;
	        			}}) ;

        			}} ;
        		}

	        	/*menu.Document = {label:'Document', action:obj=>{
						if( node_properties[node.id].longdoc != undefined )
							alert(node_properties[node.id].longdoc) ;
						else
							alert('No document available.') ;
					}} ;*/

				menu.OpenAPI = {label:'Open API',	action:obj=>{
					var path_real = node.id.replace(new RegExp('\\.','g'),'/') ;
					window.open(API_PREFIX+path_real,'_blank') ;
				}} ;

        		return menu ;
			}
			,select_node: false
        }
		,types: {
			folder: {icon: 'jstree-folder'}
			,file: {icon: 'jstree-file'}
		}
    }) ;



    /*var connection = new WebSocket('ws://192.168.126.103:8080/v1' ,['picogw']);
	connection.onopen = function () {
  		connection.send('Ping'); // Send the message 'Ping' to the server
	};

	$.ajax({
		type: "PUT",
		url: "http://192.168.126.104:8080/v1/echonet/AirConditioner_1/OperatingState?30",
		success: function(msg){
			alert( JSON.stringify(msg) );
		}
	});
	*/
} ;


</script>
</html>