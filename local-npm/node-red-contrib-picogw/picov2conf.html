<script type="text/javascript">
    RED.nodes.registerType('pico2 conf',{
        category: 'advanced',
        color: '#ff8888',
        defaults: {
            resource: {value:"Temperature",required:true},
            context: {value:undefined,required:true}
        },
        inputs:1,
        inputLabels:'Send reply or publish',
        outputs:3,
        outputLabels:['GET','PUT','DELETE'],
        icon: "picon.v2.png",
        align: "left",
        label: function() {
            return '/v2/'+this.resource+'/'+this.context || "pico2 conf";
            //return this.name||"pico v2 conf";
        }
    });
</script>

<script type="text/x-red" data-template-name="pico2 conf">
    <div class="form-row">
        <label for="node-input-resource"><i class="icon-tag"></i> Resource</label>
        <select id="node-input-resource" style="width:180px;">
            <option value="Temperature">Temperature</option>
            <option value="Luminosity">Luminosity</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-context"><i class="icon-tag"></i> Context</label>
        <input type="text" id="node-input-context" placeholder="A string that specifies a context">
    </div>
</script>

<script type="text/x-red" data-help-name="pico2 conf">
    <p>PicoGWのV2 APIを実装するためのノードです</p>
    <p>PicoGWのV2 APIは、V1 APIを使ってNode-REDで実装します。APIクライアントがPicoGWの/v2/から始まるリソース（パス）にアクセスすると、このNode-REDのノードから当該リクエスト情報が出力されます。</p>
    <p>リソースは今のところTemperature, Luminosityしかありません。それぞれGET,PUT,DELETEメソッドをサポートし、適宜更新値のpublishも行います。</p>
    <p>期待される動作</p>
    <p>temperature:</p>
    <p>・GET 現在値の取得。valueとして値（Temperatureは気温,Luminosityはルクス)を浮動小数値で返す。argsとしてt=[unixtime]の指定により、過去のログまたは将来の予測値が得られる。location=[lat,lng,alt]の指定（メートル単位）により、他の位置の値も得られる。</p>
    <p>・PUT 現在の値を変更するリクエストを送る。valueとして期待する値を浮動小数値で与える。</p>
    <p>実装上の注意</p>
    <p>このノードへの入力（すなわちAPIクライアントに出力されるデータ）は次の形式のどちらかである。</p>
    <p>Publishの場合：{method:'PUB',value:RETURN_VALUE }</p>
    <p>GET/PUTの返答の場合：{value:RETURN_VALUE,reqid:REQID_IN_NUMBER}</p>
    <p>※reqidは、本ノードの出力側(APIリクエストを受信したときの情報)から得られる。同一ノードインスタンスでなくてもよい。</p>
    <hr />
    <p>このノードから出てくるGET/PUTのリクエストをECHONET Liteのpico api callノードに入力するのは直結でよい。</p>
    <p>pico api callノードECHONET Lite出力から、v2形式に変換するfunctionノードの実装例：</p>
    <pre>
let value ;
for( let key in msg )
    if( key.charAt(0)=='/')
        value = msg[key].value ;

return { method:msg.method,value:value,reqid:msg.reqid } ;
    </pre>
    <p>
        PicoGWはECHOENT Lite対応、神奈川工科大学発のホームサーバーです。
        関連情報は<a href="http://pico.peatix.com/">こちらから</a>。
    </p>
</script>
